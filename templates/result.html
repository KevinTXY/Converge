<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 400px;
        width: 100%;
       }
    </style>
  </head>
  <script src = "https://code.jquery.com/jquery-1.12.3.min.js"></script>  <body>
  <body>
    <h3>My Google Maps Demo</h3>
    <input hidden value="{{ total }}" id="total" name="total"/>
    {% for i in range(0, total): %}
      <input hidden value="{{ items[i] }}" name="items_{{ i }}" id="items_{{ i }}"/>
    {% endfor %}

    <div id="map"></div>
    <script>

      function initMap() {

      }


      var types = [
          {code: "airport", val: "Airports"},
          {code: "amusement_park", val: "Amusement Parks"},
          {code: "aquarium", val: "Aquariums"},
          {code: "art_gallery", val: "Art Galleries"},
          {code: "bakery", val: "Bakeries"},
          {code: "bar", val: "Bars"},
          {code: "beauty_salon", val: "Beauty Salons"},
          {code: "book_store", val: "Book Stores"},
          {code: "bowling_alley", val: "Bowling Allies"},
          {code: "bus_station", val: "Bus Stations"},
          {code: "cafe", val: "Cafes"},
          {code: "casino", val: "Casinos"},
          {code: "clothing_store", val: "Clothing Stores"},
          {code: "florist", val: "Florists"},
          {code: "gym", val: "Gyms"},
          {code: "hindu_temple", val: "Hindu Temples"},
          {code: "hospital", val: "Hospitals"},
          {code: "jewelry_store", val: "Jewelry Stores"},
          {code: "laundry", val: "Laundries"},
          {code: "library", val: "Libraries"},
          {code: "liquor_store", val: "Liquor Stores"},
          {code: "mosque", val: "Mosques"},
          {code: "movie_theater", val: "Movie Theaters"},
          {code: "museum", val: "Museums"},
          {code: "night_club", val: "Night Clubs"},
          {code: "park", val: "Parks"},
          {code: "restaurant", val: "Restaurants"},
          {code: "school", val: "Schools"},
          {code: "shoe_store", val: "Shoe Stores"},
          {code: "shopping_mall", val: "Shopping Malls"},
          {code: "spa", val: "Spas"},
          {code: "stadium", val: "Stadiums"},
          {code: "store", val: "Stores"},
          {code: "subway_station", val: "Subway Stations"},
          {code: "train_station", val: "Train Stations"},
          {code: "university", val: "Universities"},
          {code: "zoo", val: "Zoos"}
      ];

      $(function() {

        $(window).load(function(){
          var image = "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"

          var map

          var total = $("#total").val();

          var items = [];

          for (var i = 0; i < total; i++) {
              items.push($("#items_" + i).val());
          }

          var sum_lat = 0;
          var sum_long = 0;

          var calls_remaining = total;
          var points = [];

          for (var i = 0; i < total; i++) {
              console.log(items[i]);
              $.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="
                + encodeURIComponent(items[i])
                + "&key=AIzaSyASFadX1MvoP2EccKogmGEyyza8UGcwHbU",
                function(data) {
                    console.log(data);
                    sum_lat += data.results[0].geometry.location.lat;
                    sum_long += data.results[0].geometry.location.lng;
                    points.push([data.results[0].geometry.location.lat, data.results[0].geometry.location.lng]);
                    console.log("LAT:" + data.results[0].geometry.location.lng);
                    console.log("LNG:" + data.results[0].geometry.location.lat);
                    calls_remaining--;
                    if (calls_remaining <= 0) {
                      var avg_lat = sum_lat / total;
                      var avg_long = sum_long / total;
                      console.log(avg_lat, avg_long);

                      map = new google.maps.Map($("#map").get(0), {
                            center: {lat: avg_lat, lng: avg_long},
                            disableDefaultUI: true,
                            mapTypeId: google.maps.MapTypeId.ROADMAP,
                            maxZoom: 14,
                            panControl: true,
                            zoom: 13,
                            zoomControl: true
                        });
                        console.log(data.results)

                        var i = 0
                        points.forEach(function(element){
                          console.log("THIS ELEMENT:  " + element);
                          var loc = new google.maps.LatLng(element[0], element[1]);
                          var mark = new google.maps.Marker({
                            position: loc,
                            label: i.toString(),
                            icon: image
                          });
                          i++;
                          mark.setMap(map);
                        });

                      var location = new google.maps.LatLng(avg_lat, avg_long);
                      var label = "P";
                      var marker = new google.maps.Marker({
                        position: location,
                        label: label,
                      });
                      marker.setMap(map);

                      var service = new google.maps.places.PlacesService(map);
                                  service.nearbySearch({
                                    location:location,
                                    radius: 500,
                                    type: ['restaurant']
                                  }, callback);
                      function callback(results, status) {
                        if (status === google.maps.places.PlacesServiceStatus.OK){
                          for (var i=0; i < results.length; i++) {
                            createMarker(results[i]);
                          }
                        }
                      }
                      var infowindow = new google.maps.InfoWindow({});
                      function createMarker(place) {
                        var placeLoc = place.geometry.location;
                        var marker = new google.maps.Marker({
                          map:map,
                          position: place.geometry.location
                        });
                        google.maps.event.addListener(marker, 'click', function() {
                          var content = "";
                          content += "<img width=\"15px\" src=\"" + place.icon + "\">";
                          content +=  "<b> " + place.name + "</b><br>";
                          content += "Address: " + place.vicinity; + "<br>";

                          infowindow.setContent(content);
                          infowindow.open(map, this);
                        });
                      }
                    }
                  });
            }
        });
      });

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBc6mdcCJazqLOtekNhnf0VFh624UoImWg&callback=initMap&libraries=places">
    </script>
  </body>
</html>
